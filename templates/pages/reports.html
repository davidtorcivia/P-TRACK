{{ define "content" }}
<article class="card" style="margin-bottom: var(--space-6);">
    <hgroup>
        <h1>Reports & Analytics</h1>
        <p>View and export your injection and symptom data</p>
    </hgroup>
</article>

<div class="grid desktop-grid-cols-2" style="gap: var(--space-6); align-items: start;">
    <!-- Date Range Selection -->
    <article class="card" style="margin: 0;">
        <h3>Select Date Range</h3>
        <form x-data="{ startDate: '', endDate: '', courseId: '' }" style="margin-top: var(--space-4);">
            <label for="start-date">
                Start Date
                <input type="date" id="start-date" x-model="startDate" required>
            </label>

            <label for="end-date">
                End Date
                <input type="date" id="end-date" x-model="endDate" required>
            </label>

            <label for="course-filter">
                Course (optional)
                <select id="course-filter" x-model="courseId"
                        hx-get="/api/courses"
                        hx-trigger="load"
                        hx-swap="innerHTML">
                    <option value="">All Courses</option>
                </select>
            </label>

            <div class="grid desktop-grid-cols-2" style="gap: var(--space-4); margin-top: var(--space-4);">
                <button type="button"
                        @click="window.location.href = `/api/export/pdf?start_date=${startDate}&end_date=${endDate}&course_id=${courseId}`"
                        :disabled="!startDate || !endDate"
                        class="w-full">
                    Export PDF
                </button>
                <button type="button"
                        @click="window.location.href = `/api/export/csv?start_date=${startDate}&end_date=${endDate}&course_id=${courseId}`"
                        :disabled="!startDate || !endDate"
                        class="outline w-full">
                    Export CSV
                </button>
            </div>
        </form>
    </article>

    <!-- Quick Stats -->
    <article class="card" style="margin: 0;">
        <h3>Quick Statistics</h3>
        <div hx-get="/api/injections/stats"
             hx-trigger="load"
             hx-swap="innerHTML"
             style="margin-top: var(--space-4);">
            <p aria-busy="true">Loading stats...</p>
        </div>
    </article>
</div>

<!-- Charts Section -->
<article class="card" style="margin-top: var(--space-6);">
    <h3 style="margin-bottom: var(--space-4);">Data Visualization</h3>

    <div class="grid desktop-grid-cols-2" style="gap: var(--space-8);">
        <div>
            <h4 class="text-center text-secondary text-sm uppercase tracking-wide mb-4">Injection Frequency</h4>
            <canvas id="injection-frequency-chart"></canvas>
        </div>
        <div>
            <h4 class="text-center text-secondary text-sm uppercase tracking-wide mb-4">Pain Levels Over Time</h4>
            <canvas id="pain-trend-chart"></canvas>
        </div>
    </div>

    <div class="grid desktop-grid-cols-2" style="gap: var(--space-8); margin-top: var(--space-8);">
        <div>
            <h4 class="text-center text-secondary text-sm uppercase tracking-wide mb-4">Side Distribution</h4>
            <canvas id="side-distribution-chart"></canvas>
        </div>
        <div>
            <h4 class="text-center text-secondary text-sm uppercase tracking-wide mb-4">Symptom Frequency</h4>
            <canvas id="symptom-frequency-chart"></canvas>
        </div>
    </div>
</article>

<!-- Recent Activity Table -->
<article class="card" style="margin-top: var(--space-6);">
    <h3>Recent Injections</h3>
    <div hx-get="/api/injections/recent"
         hx-trigger="load"
         hx-swap="innerHTML"
         style="margin-top: var(--space-4);">
        <p aria-busy="true">Loading recent injections...</p>
    </div>
</article>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Fetch chart data
    fetch('/api/injections/stats')
        .then(response => response.json())
        .then(data => {
            initCharts(data);
        })
        .catch(error => console.error('Error fetching chart data:', error));
});

function initCharts(data) {
    // Injection Frequency Chart
    if (document.getElementById('injection-frequency-chart')) {
        const dates = Object.keys(data.frequency_by_day || {}).sort();
        const counts = dates.map(date => data.frequency_by_day[date]);

        new Chart(document.getElementById('injection-frequency-chart'), {
            type: 'bar',
            data: {
                labels: dates.map(d => new Date(d).toLocaleDateString()),
                datasets: [{
                    label: 'Injections',
                    data: counts,
                    backgroundColor: 'rgba(52, 211, 153, 0.5)',
                    borderColor: 'rgba(52, 211, 153, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0 } }
                }
            }
        });
    }

    // Pain Trend Chart
    if (document.getElementById('pain-trend-chart') && data.pain_trend) {
        const dates = data.pain_trend.map(p => new Date(p.date).toLocaleDateString());
        const levels = data.pain_trend.map(p => p.pain_level);

        new Chart(document.getElementById('pain-trend-chart'), {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Pain Level',
                    data: levels,
                    borderColor: 'rgba(239, 68, 68, 0.8)',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, max: 10 }
                }
            }
        });
    }

    // Side Distribution Chart
    if (document.getElementById('side-distribution-chart')) {
        new Chart(document.getElementById('side-distribution-chart'), {
            type: 'doughnut',
            data: {
                labels: ['Left', 'Right'],
                datasets: [{
                    data: [data.left_count || 0, data.right_count || 0],
                    backgroundColor: [
                        'rgba(14, 116, 144, 0.7)', // Teal/Cyan
                        'rgba(59, 130, 246, 0.7)'  // Blue
                    ],
                    borderColor: [
                        'rgba(14, 116, 144, 1)',
                        'rgba(59, 130, 246, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true
            }
        });
    }

    // Symptom Frequency - Need separate endpoint or extra data for this
    // Placeholder for now or remove if data not available
}
</script>
{{ end }}
