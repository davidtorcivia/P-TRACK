{{ define "content" }}
<div x-data="{ showNewMedicationModal: false }">
<article>
    <header>
        <hgroup>
            <h1>Medications</h1>
            <p>Track pills, supplements, and other medications</p>
        </hgroup>
        <button @click="showNewMedicationModal = true">
            + Add Medication
        </button>
    </header>

    <!-- Active Medications -->
    <article>
        <header>
            <h3>Active Medications</h3>
        </header>

        {{ if .ActiveMedications }}
        <div class="grid">
            {{ range .ActiveMedications }}
            <article>
                <header>
                    <h4 style="margin-bottom: 0.25rem;">{{ .Name }}</h4>
                    <small>{{ .Dosage }} • {{ .Frequency }}</small>
                </header>

                <div style="margin: 1rem 0;">
                    <!-- Today's status -->
                    {{ if .TakenToday }}
                    <p style="color: var(--pico-success);">✓ Taken today</p>
                    {{ else }}
                    <p style="color: var(--pico-warning);">⚠️ Not taken yet</p>
                    {{ end }}

                    <!-- Quick log button -->
                    <button onclick="
                            const btn = this;
                            btn.disabled = true;
                            fetch('/api/medications/{{ .ID }}/log', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRF-Token': '{{ $.CSRFToken }}'
                                },
                                body: JSON.stringify({taken: true})
                            }).then(() => window.location.reload())
                            .catch(() => btn.disabled = false);"
                            class="outline"
                            style="width: 100%;"
                            {{ if .TakenToday }}disabled{{ end }}>
                        {{ if .TakenToday }}Already Taken{{ else }}Mark as Taken{{ end }}
                    </button>
                </div>

                <footer>
                    <div class="grid" style="grid-template-columns: 1fr 1fr 1fr;">
                        <button onclick="alert('Edit functionality coming soon')"
                                class="outline" style="font-size: 0.9rem;">
                            Edit
                        </button>
                        <button onclick="if(confirm('Stop tracking {{ .Name }}?')) {
                                    fetch('/api/medications/{{ .ID }}', {
                                        method: 'DELETE',
                                        headers: {'X-CSRF-Token': '{{ $.CSRFToken }}'}
                                    }).then(() => window.location.reload());
                                }"
                                class="outline secondary" style="font-size: 0.9rem;">
                            Deactivate
                        </button>
                        <button onclick="window.location.href='/medications/{{ .ID }}/logs'"
                                class="outline" style="font-size: 0.9rem;">
                            View History
                        </button>
                    </div>
                </footer>
            </article>
            {{ end }}
        </div>
        {{ else }}
        <p style="text-align: center; color: var(--pico-muted-color);">
            No active medications. <a href="#" @click="showNewMedicationModal = true">Add one</a>
        </p>
        {{ end }}
    </article>

    <!-- Today's Schedule -->
    <article>
        <header>
            <h3>Today's Schedule</h3>
        </header>

        <div id="daily-schedule"
             hx-get="/api/medications/schedule/today"
             hx-trigger="load, every 60s"
             hx-swap="innerHTML">
            <p aria-busy="true">Loading schedule...</p>
        </div>
    </article>

    <!-- Adherence Chart -->
    <article>
        <header>
            <h3>Adherence (Last 30 Days)</h3>
        </header>

        <div class="chart-container">
            <canvas id="adherence-chart"></canvas>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', async () => {
                const response = await fetch('/api/medications/adherence?days=30');
                const data = await response.json();

                const ctx = document.getElementById('adherence-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.medications,
                        datasets: [{
                            label: 'Taken',
                            data: data.taken,
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        }, {
                            label: 'Missed',
                            data: data.missed,
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
        </script>
    </article>

    <!-- Inactive Medications -->
    {{ if .InactiveMedications }}
    <details>
        <summary>Inactive Medications ({{ len .InactiveMedications }})</summary>

        <div style="padding: 1rem;">
            <ul style="list-style: none; padding: 0;">
                {{ range .InactiveMedications }}
                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--pico-muted-border-color);">
                    <strong>{{ .Name }}</strong> - {{ .Dosage }}
                    <small>({{ .FormattedEndDate }})</small>
                    <button hx-post="/api/medications/{{ .ID }}/reactivate"
                            hx-confirm="Reactivate this medication?"
                            class="outline"
                            style="float: right;">
                        Reactivate
                    </button>
                </li>
                {{ end }}
            </ul>
        </div>
    </details>
    {{ end }}
</article>

<!-- New Medication Modal -->
<dialog :open="showNewMedicationModal" @click="if($event.target === $el) showNewMedicationModal = false">
    <article style="max-width: 600px; margin: 2rem auto;">
        <header>
            <button @click="showNewMedicationModal = false" aria-label="Close" rel="prev" style="float: right;"></button>
            <h2>Add Medication</h2>
        </header>

        <form x-data="{
                  name: '',
                  dosage: '',
                  frequency: '',
                  startDate: new Date().toISOString().split('T')[0],
                  notes: ''
              }"
              @submit.prevent="
                const btn = $el.querySelector('button[type=submit]');
                btn.disabled = true;
                btn.textContent = 'Adding...';
                fetch('/api/medications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': '{{ .CSRFToken }}'
                    },
                    body: JSON.stringify({
                        name: name,
                        dosage: dosage,
                        frequency: frequency,
                        start_date: startDate,
                        notes: notes || null
                    })
                })
                .then(response => {
                    if (response.ok) {
                        showNewMedicationModal = false;
                        window.location.reload();
                    } else {
                        btn.disabled = false;
                        btn.textContent = 'Add Medication';
                        response.text().then(text => {
                            document.getElementById('medication-feedback').innerHTML = '<div class=error-message>' + text + '</div>';
                        });
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.textContent = 'Add Medication';
                    document.getElementById('medication-feedback').innerHTML = '<div class=error-message>Error: ' + error.message + '</div>';
                });
              ">

            <div id="medication-feedback"></div>

            <label for="med_name">
                Medication Name *
                <input type="text"
                       id="med_name"
                       x-model="name"
                       placeholder="e.g., Prenatal Vitamin, Progesterone Pills"
                       required
                       autofocus>
            </label>

            <div class="grid">
                <label for="dosage">
                    Dosage *
                    <input type="text"
                           id="dosage"
                           x-model="dosage"
                           placeholder="e.g., 200mg, 1 tablet"
                           required>
                </label>

                <label for="frequency">
                    Frequency *
                    <input type="text"
                           id="frequency"
                           x-model="frequency"
                           placeholder="e.g., Once daily, Twice daily"
                           required>
                </label>
            </div>

            <label for="start_date">
                Start Date *
                <input type="date"
                       id="start_date"
                       x-model="startDate"
                       required>
            </label>

            <label for="med_notes">
                Notes (optional)
                <textarea id="med_notes"
                          x-model="notes"
                          rows="2"
                          placeholder="Any special instructions..."></textarea>
            </label>

            <footer>
                <button type="button" @click="showNewMedicationModal = false" class="secondary">
                    Cancel
                </button>
                <button type="submit" :disabled="!name || !dosage || !frequency">
                    Add Medication
                </button>
            </footer>
        </form>
    </article>
</dialog>
</div>
{{ end }}