{{ define "content" }}
<article style="padding: 1rem;">
    <header>
        <hgroup>
            <h1>Settings</h1>
            <p>Manage your account and preferences</p>
        </hgroup>
    </header>
</article>

<div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1rem; align-items: start;">
    <!-- Profile Settings -->
    <article style="margin: 0;">
        <header>
            <h3>Profile</h3>
        </header>

        <form hx-post="/api/settings/profile"
              hx-target="#profile-feedback"
              hx-swap="innerHTML">

            <div id="profile-feedback"></div>

            <label for="username">
                Username
                <input type="text"
                       id="username"
                       name="username"
                       value="{{ .User.Username }}"
                       required
                       minlength="3">
            </label>

            <label for="email">
                Email
                <input type="email"
                       id="email"
                       name="email"
                       value="{{ .User.Email }}"
                       placeholder="your@email.com">
                <small>For password recovery only</small>
            </label>

            <button type="submit">Update Profile</button>
        </form>
    </article>

    <!-- Change Password -->
    <article style="margin: 0;">
        <header>
            <h3>Change Password</h3>
        </header>

        <form hx-post="/api/settings/password"
              hx-target="#password-feedback"
              hx-swap="innerHTML"
              x-data="{ newPassword: '', confirmPassword: '', passwordMatch: true }">

            <div id="password-feedback"></div>

            <label for="current-password">
                Current Password
                <input type="password"
                       id="current-password"
                       name="current_password"
                       required>
            </label>

            <label for="new-password">
                New Password
                <input type="password"
                       id="new-password"
                       name="new_password"
                       x-model="newPassword"
                       @input="passwordMatch = newPassword === confirmPassword || confirmPassword === ''"
                       minlength="8"
                       required>
                <small>Minimum 8 characters</small>
            </label>

            <label for="confirm-password">
                Confirm New Password
                <input type="password"
                       id="confirm-password"
                       name="confirm_password"
                       x-model="confirmPassword"
                       @input="passwordMatch = newPassword === confirmPassword"
                       :aria-invalid="!passwordMatch && confirmPassword !== ''"
                       required>
                <small x-show="!passwordMatch && confirmPassword !== ''" style="color: var(--pico-del-color);">
                    Passwords do not match
                </small>
            </label>

            <button type="submit" :disabled="!passwordMatch">
                Change Password
            </button>
        </form>
    </article>
</div>

<!-- App Settings -->
<article style="padding: 1rem;">
    <header>
        <h3>Application Settings</h3>
    </header>

    <form hx-post="/api/settings/app"
          hx-target="#app-feedback"
          hx-swap="innerHTML"
          x-data="{}"
          @htmx:after-request="
            if ($event.detail.successful) {
                const theme = document.getElementById('theme').value;
                if (theme === 'auto') {
                    window.themeManager.setAutoTheme();
                } else {
                    window.themeManager.setTheme(theme);
                }
                $el.querySelector('#app-feedback').innerHTML = '<mark>Settings saved successfully!</mark>';
                setTimeout(() => $el.querySelector('#app-feedback').innerHTML = '', 3000);
            }
          ">

        <div id="app-feedback"></div>

        <div class="grid">
            <label for="theme">
                Theme
                <select id="theme" name="theme">
                    <option value="light" {{ if eq .Settings.Theme "light" }}selected{{ end }}>Light</option>
                    <option value="dark" {{ if eq .Settings.Theme "dark" }}selected{{ end }}>Dark</option>
                    <option value="auto" {{ if eq .Settings.Theme "auto" }}selected{{ end }}>Auto (System)</option>
                </select>
            </label>

            <label for="timezone">
                Timezone
                <select id="timezone" name="timezone">
                    <option value="America/New_York" {{ if eq .Settings.Timezone "America/New_York" }}selected{{ end }}>Eastern Time (ET)</option>
                    <option value="America/Chicago" {{ if eq .Settings.Timezone "America/Chicago" }}selected{{ end }}>Central Time (CT)</option>
                    <option value="America/Denver" {{ if eq .Settings.Timezone "America/Denver" }}selected{{ end }}>Mountain Time (MT)</option>
                    <option value="America/Phoenix" {{ if eq .Settings.Timezone "America/Phoenix" }}selected{{ end }}>Arizona Time (AZ)</option>
                    <option value="America/Los_Angeles" {{ if eq .Settings.Timezone "America/Los_Angeles" }}selected{{ end }}>Pacific Time (PT)</option>
                    <option value="America/Anchorage" {{ if eq .Settings.Timezone "America/Anchorage" }}selected{{ end }}>Alaska Time (AK)</option>
                    <option value="Pacific/Honolulu" {{ if eq .Settings.Timezone "Pacific/Honolulu" }}selected{{ end }}>Hawaii Time (HT)</option>
                    <option value="UTC" {{ if eq .Settings.Timezone "UTC" }}selected{{ end }}>UTC</option>
                    <option value="Europe/London" {{ if eq .Settings.Timezone "Europe/London" }}selected{{ end }}>London (GMT/BST)</option>
                    <option value="Europe/Paris" {{ if eq .Settings.Timezone "Europe/Paris" }}selected{{ end }}>Central Europe (CET)</option>
                    <option value="Europe/Athens" {{ if eq .Settings.Timezone "Europe/Athens" }}selected{{ end }}>Eastern Europe (EET)</option>
                    <option value="Asia/Dubai" {{ if eq .Settings.Timezone "Asia/Dubai" }}selected{{ end }}>Dubai (GST)</option>
                    <option value="Asia/Kolkata" {{ if eq .Settings.Timezone "Asia/Kolkata" }}selected{{ end }}>India (IST)</option>
                    <option value="Asia/Shanghai" {{ if eq .Settings.Timezone "Asia/Shanghai" }}selected{{ end }}>China (CST)</option>
                    <option value="Asia/Tokyo" {{ if eq .Settings.Timezone "Asia/Tokyo" }}selected{{ end }}>Japan (JST)</option>
                    <option value="Australia/Sydney" {{ if eq .Settings.Timezone "Australia/Sydney" }}selected{{ end }}>Sydney (AEDT)</option>
                    <option value="Pacific/Auckland" {{ if eq .Settings.Timezone "Pacific/Auckland" }}selected{{ end }}>New Zealand (NZDT)</option>
                </select>
                <small>All dates and times will be shown in your timezone</small>
            </label>
        </div>

        <div class="grid">
            <label for="date-format">
                Date Format
                <select id="date-format" name="date_format">
                    <option value="MM/DD/YYYY" {{ if eq .Settings.DateFormat "MM/DD/YYYY" }}selected{{ end }}>MM/DD/YYYY</option>
                    <option value="DD/MM/YYYY" {{ if eq .Settings.DateFormat "DD/MM/YYYY" }}selected{{ end }}>DD/MM/YYYY</option>
                    <option value="YYYY-MM-DD" {{ if eq .Settings.DateFormat "YYYY-MM-DD" }}selected{{ end }}>YYYY-MM-DD</option>
                </select>
            </label>

            <label for="time-format">
                Time Format
                <select id="time-format" name="time_format">
                    <option value="12h" {{ if eq .Settings.TimeFormat "12h" }}selected{{ end }}>12-hour (AM/PM)</option>
                    <option value="24h" {{ if eq .Settings.TimeFormat "24h" }}selected{{ end }}>24-hour</option>
                </select>
            </label>
        </div>

        <label for="advanced-mode">
            <input type="checkbox"
                   id="advanced-mode"
                   name="advanced_mode"
                   role="switch"
                   {{ if .Settings.AdvancedMode }}checked{{ end }}>
            Enable Advanced Mode
            <small>Shows anatomical diagram for precise injection site tracking</small>
        </label>

        <button type="submit">Save Settings</button>
    </form>
</article>

<!-- Notification Settings -->
<article style="padding: 1rem;">
    <header>
        <h3>Notifications & Reminders</h3>
    </header>

    <form hx-post="/api/settings/notifications"
          hx-target="#notification-feedback"
          hx-swap="innerHTML">

        <div id="notification-feedback"></div>

        <label for="enable-notifications">
            <input type="checkbox"
                   id="enable-notifications"
                   name="enable_notifications"
                   role="switch"
                   {{ if .Settings.EnableNotifications }}checked{{ end }}>
            Enable Push Notifications
            <small>Receive browser notifications for reminders</small>
        </label>

        <label for="injection-reminders">
            <input type="checkbox"
                   id="injection-reminders"
                   name="injection_reminders"
                   role="switch"
                   {{ if .Settings.InjectionReminders }}checked{{ end }}>
            Injection Reminders
            <small>Get reminded when it's time for your next injection</small>
        </label>

        <label for="reminder-time">
            Default Reminder Time
            <input type="time"
                   id="reminder-time"
                   name="reminder_time"
                   value="{{ .Settings.ReminderTime }}">
            <small>Default time for medication reminders</small>
        </label>

        <label for="low-stock-alerts">
            <input type="checkbox"
                   id="low-stock-alerts"
                   name="low_stock_alerts"
                   role="switch"
                   {{ if .Settings.LowStockAlerts }}checked{{ end }}>
            Low Stock Alerts
            <small>Get notified when inventory is running low</small>
        </label>

        <button type="submit">Save Notification Settings</button>
    </form>
</article>

<!-- Data Management -->
<article style="padding: 1rem;">
    <header>
        <h3>Data Management</h3>
    </header>

    <div class="grid">
        <div>
            <button onclick="window.location.href='/api/export/all'"
                    class="outline"
                    style="width: 100%;">
                Export All Data
            </button>
            <small>Download all data as JSON</small>
        </div>

        <div>
            <button onclick="window.location.href='/api/export/pdf?full=true'"
                    class="outline"
                    style="width: 100%;">
                Generate Full Report
            </button>
            <small>Create PDF report for healthcare provider</small>
        </div>
    </div>

    <details style="margin-top: 2rem;">
        <summary style="color: var(--pico-del-color);">
            <strong>Danger Zone</strong>
        </summary>

        <div style="padding: 1rem; border: 1px solid var(--pico-del-color); border-radius: var(--pico-border-radius); margin-top: 1rem; background-color: var(--pico-card-background-color);">
            <p><strong>Delete All Data</strong></p>
            <p>This will permanently delete all your injections, symptoms, medications, and courses. This action cannot be undone.</p>
            <button onclick="showDeleteAllConfirmation()"
                    class="outline"
                    style="color: var(--pico-del-color); border-color: var(--pico-del-color);">
                Delete All Data
            </button>
        </div>
    </details>
</article>

<!-- About -->
<article style="padding: 1rem;">
    <header>
        <h3>About</h3>
    </header>

    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
        <div>
            <strong>Version</strong>
            <p>1.0.0</p>
        </div>

        <div>
            <strong>Database Size</strong>
            <p>{{ .DatabaseSize }}</p>
        </div>

        <div>
            <strong>Last Backup</strong>
            <p>{{ .LastBackup }}</p>
        </div>

        <div>
            <strong>Documentation</strong>
            <p><a href="https://github.com/yourusername/injection-tracker" target="_blank">View on GitHub</a></p>
        </div>
    </div>
</article>

<!-- Delete All Data Confirmation Dialog -->
<dialog id="delete-all-data-confirm">
    <article style="max-width: 500px;">
        <header>
            <h3>Confirm Data Deletion</h3>
        </header>
        <p><strong>This will permanently delete ALL of your data:</strong></p>
        <ul>
            <li>All injection records</li>
            <li>All symptom logs</li>
            <li>All medications</li>
            <li>All courses</li>
            <li>All inventory history</li>
        </ul>
        <p style="color: var(--pico-del-color);"><strong>This action CANNOT be undone!</strong></p>
        <p>Type <strong>DELETE</strong> to confirm:</p>
        <input type="text" id="delete-confirmation-input" placeholder="Type DELETE" style="font-family: monospace;">
        <footer>
            <div class="grid-2">
                <button type="button" class="secondary" onclick="document.getElementById('delete-all-data-confirm').close(); document.getElementById('delete-confirmation-input').value = '';">Cancel</button>
                <button type="button" class="contrast" onclick="confirmDeleteAllData()">Delete Everything</button>
            </div>
        </footer>
    </article>
</dialog>

<script>
function showDeleteAllConfirmation() {
    document.getElementById('delete-all-data-confirm').showModal();
}

function confirmDeleteAllData() {
    const input = document.getElementById('delete-confirmation-input');
    if (input.value !== 'DELETE') {
        alert('Please type DELETE to confirm');
        return;
    }

    fetch('/api/settings/all-data', {
        method: 'DELETE',
        headers: {
            'X-CSRF-Token': '{{ .CSRFToken }}'
        }
    })
    .then(response => {
        if (response.ok) {
            window.location.href = '/logout';
        } else {
            console.error('Error deleting data');
            alert('Error deleting data. Please try again.');
        }
    });
}
</script>

<style>
/* Better spacing for settings page */
article {
    margin-bottom: 1rem;
}

/* Improve form layout */
label small {
    display: block;
    margin-top: 0.25rem;
    color: var(--pico-muted-color);
}

/* Grid improvements */
.grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
}

@media (max-width: 768px) {
    .grid {
        grid-template-columns: 1fr !important;
    }
}
</style>
{{ end }}
