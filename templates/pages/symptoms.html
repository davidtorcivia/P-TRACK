{{ define "content" }}
<hgroup>
    <h2>Symptom Tracking</h2>
    <p>Log and monitor your symptoms</p>
</hgroup>

<div id="notification" style="display: none; margin-bottom: var(--space-4);" role="alert"></div>

{{ if .ActiveCourse }}
<article class="card">
    <header><h3>Log Symptoms</h3></header>

    <form x-data="{
        painLevel: 5,
        painLocation: '',
        customLocation: '',
        painType: '',
        hasKnots: false,
        symptoms: [],
        notes: ''
    }" @submit.prevent="
        const btn = $el.querySelector('button[type=submit]');
        btn.disabled = true;
        btn.setAttribute('aria-busy', 'true');

        fetch('/api/symptoms', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content
            },
            body: JSON.stringify({
                course_id: {{ .ActiveCourse.ID }},
                pain_level: parseInt(painLevel),
                pain_location: painLocation === 'custom' ? customLocation : painLocation,
                pain_type: painType,
                has_knots: hasKnots,
                symptoms: symptoms,
                notes: notes
            })
        })
        .then(response => {
            btn.disabled = false;
            btn.removeAttribute('aria-busy');
            if (response.ok) {
                painLevel = 5;
                painLocation = '';
                painType = '';
                hasKnots = false;
                symptoms = [];
                notes = '';

                const notif = document.getElementById('notification');
                notif.innerHTML = '<div class=\'alert-success\'>Symptoms logged successfully!</div>';
                notif.style.display = 'block';
                setTimeout(() => notif.style.display = 'none', 3000);

                htmx.trigger('#recent-symptoms', 'refresh');
            } else {
                response.text().then(text => {
                    const notif = document.getElementById('notification');
                    notif.innerHTML = '<div class=\'alert-danger\'>Error: ' + text + '</div>';
                    notif.style.display = 'block';
                });
            }
        })
        .catch(error => {
            btn.disabled = false;
            btn.removeAttribute('aria-busy');
            const notif = document.getElementById('notification');
            notif.innerHTML = '<div class=\'alert-danger\'>Error: ' + error.message + '</div>';
            notif.style.display = 'block';
        });
    ">
        <div class="grid-3">
            <div>
                <label>
                    Pain Level: <span x-text="painLevel"></span>/10
                    <input type="range" x-model="painLevel" min="1" max="10" style="width: 100%;">
                </label>
            </div>

            <div>
                <label>
                    Location
                    <select x-model="painLocation">
                        <option value="">Select</option>
                        <option value="injection_site_left">Injection Site - Left</option>
                        <option value="injection_site_right">Injection Site - Right</option>
                        <option value="injection_site_both">Injection Site - Both</option>
                        <option value="upper_buttock_left">Upper Buttock - Left</option>
                        <option value="upper_buttock_right">Upper Buttock - Right</option>
                        <option value="abdomen">Abdomen</option>
                        <option value="lower_back">Lower Back</option>
                        <option value="custom">Custom (specify below)</option>
                    </select>
                </label>
                <div x-show="painLocation === 'custom'" style="margin-top: 0.5rem;">
                    <input type="text" x-model="customLocation" placeholder="Describe location...">
                </div>
            </div>

            <div>
                <label>
                    Type
                    <select x-model="painType">
                        <option value="">Select</option>
                        <option value="sharp">Sharp</option>
                        <option value="dull">Dull</option>
                        <option value="aching">Aching</option>
                        <option value="cramping">Cramping</option>
                        <option value="other">Other</option>
                    </select>
                </label>
            </div>
        </div>

        <div style="margin-bottom: 1rem;">
            <label class="flex items-center gap-2">
                <input type="checkbox" x-model="hasKnots" role="switch" style="width: 2rem;">
                <span>Has Knots/Hardness at Site</span>
            </label>
        </div>

        <fieldset>
            <legend>Additional Symptoms</legend>
            <div class="grid-4">
                <label class="flex items-center gap-2"><input type="checkbox" x-model="symptoms" value="nausea" style="width: 1rem; height: 1rem;"> Nausea</label>
                <label class="flex items-center gap-2"><input type="checkbox" x-model="symptoms" value="fatigue" style="width: 1rem; height: 1rem;"> Fatigue</label>
                <label class="flex items-center gap-2"><input type="checkbox" x-model="symptoms" value="headache" style="width: 1rem; height: 1rem;"> Headache</label>
                <label class="flex items-center gap-2"><input type="checkbox" x-model="symptoms" value="mood_changes" style="width: 1rem; height: 1rem;"> Mood Changes</label>
                <label class="flex items-center gap-2"><input type="checkbox" x-model="symptoms" value="bloating" style="width: 1rem; height: 1rem;"> Bloating</label>
                <label class="flex items-center gap-2"><input type="checkbox" x-model="symptoms" value="breast_tenderness" style="width: 1rem; height: 1rem;"> Tenderness</label>
                <label class="flex items-center gap-2"><input type="checkbox" x-model="symptoms" value="spotting" style="width: 1rem; height: 1rem;"> Spotting</label>
                <label class="flex items-center gap-2"><input type="checkbox" x-model="symptoms" value="hot_flashes" style="width: 1rem; height: 1rem;"> Hot Flashes</label>
                <label class="flex items-center gap-2"><input type="checkbox" x-model="symptoms" value="knots" style="width: 1rem; height: 1rem;"> Knots</label>
            </div>
        </fieldset>

        <label>
            Notes
            <textarea x-model="notes" rows="3"></textarea>
        </label>

        <button type="submit" class="w-full">Log Symptoms</button>
    </form>
</article>

<article class="card">
    <header><h3>Recent Symptoms</h3></header>
    <div id="recent-symptoms" hx-get="/api/symptoms/recent" hx-trigger="load, refresh from:body">
        <p aria-busy="true">Loading...</p>
    </div>
    <footer>
        <a href="/symptoms/history" role="button" class="btn outline w-full">View History</a>
    </footer>
</article>

<!-- Edit Symptom Modal -->
<dialog id="edit-symptom-modal">
    <article>
        <header>
            <h3>Edit Symptom Log</h3>
            <button aria-label="Close" rel="prev" onclick="document.getElementById('edit-symptom-modal').close()"></button>
        </header>
        <form id="edit-symptom-form" x-data="{
            symptomId: 0,
            painLevel: 5,
            painLocation: '',
            customLocation: '',
            painType: '',
            symptoms: [],
            notes: ''
        }" @submit.prevent="
            const btn = $el.querySelector('button[type=submit]');
            btn.disabled = true;
            btn.setAttribute('aria-busy', 'true');

            fetch('/api/symptoms/' + symptomId, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content
                },
                body: JSON.stringify({
                    pain_level: parseInt(painLevel),
                    pain_location: painLocation === 'custom' ? customLocation : painLocation,
                    pain_type: painType,
                    symptoms: symptoms,
                    notes: notes
                })
            })
            .then(response => {
                if (response.ok) {
                    document.getElementById('edit-symptom-modal').close();
                    htmx.trigger('#recent-symptoms', 'refresh');
                    const notif = document.getElementById('notification');
                    notif.innerHTML = '<div class=\'alert-success\'>Symptom updated successfully!</div>';
                    notif.style.display = 'block';
                    setTimeout(() => notif.style.display = 'none', 3000);
                } else {
                    response.text().then(text => {
                        console.error('Error:', text);
                        btn.disabled = false;
                        btn.removeAttribute('aria-busy');
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error.message);
                btn.disabled = false;
                btn.removeAttribute('aria-busy');
            });
        ">
            <label>
                Pain Level: <span x-text="painLevel"></span>/10
                <input type="range" x-model="painLevel" min="1" max="10" style="width: 100%;">
            </label>

            <div class="grid-2">
                <label>
                    Location
                    <select x-model="painLocation">
                        <option value="">Select</option>
                        <option value="injection_site_left">Injection Site - Left</option>
                        <option value="injection_site_right">Injection Site - Right</option>
                        <option value="injection_site_both">Injection Site - Both</option>
                        <option value="upper_buttock_left">Upper Buttock - Left</option>
                        <option value="upper_buttock_right">Upper Buttock - Right</option>
                        <option value="abdomen">Abdomen</option>
                        <option value="lower_back">Lower Back</option>
                        <option value="custom">Custom (specify below)</option>
                    </select>
                </label>

                <label>
                    Type
                    <select x-model="painType">
                        <option value="">Select</option>
                        <option value="sharp">Sharp</option>
                        <option value="dull">Dull</option>
                        <option value="aching">Aching</option>
                        <option value="cramping">Cramping</option>
                        <option value="other">Other</option>
                    </select>
                </label>
            </div>

            <div x-show="painLocation === 'custom'">
                <input type="text" x-model="customLocation" placeholder="Describe location...">
            </div>

            <fieldset>
                <legend>Additional Symptoms</legend>
                <div class="grid-4">
                    <label class="flex items-center gap-2"><input type="checkbox" x-model="symptoms" value="nausea" style="width: 1rem; height: 1rem;"> Nausea</label>
                    <label class="flex items-center gap-2"><input type="checkbox" x-model="symptoms" value="fatigue" style="width: 1rem; height: 1rem;"> Fatigue</label>
                    <label class="flex items-center gap-2"><input type="checkbox" x-model="symptoms" value="headache" style="width: 1rem; height: 1rem;"> Headache</label>
                    <label class="flex items-center gap-2"><input type="checkbox" x-model="symptoms" value="mood_changes" style="width: 1rem; height: 1rem;"> Mood Changes</label>
                    <label class="flex items-center gap-2"><input type="checkbox" x-model="symptoms" value="bloating" style="width: 1rem; height: 1rem;"> Bloating</label>
                    <label class="flex items-center gap-2"><input type="checkbox" x-model="symptoms" value="breast_tenderness" style="width: 1rem; height: 1rem;"> Tenderness</label>
                    <label class="flex items-center gap-2"><input type="checkbox" x-model="symptoms" value="spotting" style="width: 1rem; height: 1rem;"> Spotting</label>
                    <label class="flex items-center gap-2"><input type="checkbox" x-model="symptoms" value="hot_flashes" style="width: 1rem; height: 1rem;"> Hot Flashes</label>
                </div>
            </fieldset>

            <label>
                Notes
                <textarea x-model="notes" rows="3"></textarea>
            </label>

            <footer>
                <div class="grid-2">
                    <button type="button" class="secondary" onclick="document.getElementById('edit-symptom-modal').close()">Cancel</button>
                    <button type="submit">Update Symptom</button>
                </div>
            </footer>
        </form>
    </article>
</dialog>

<script>
document.addEventListener('click', function(e) {
    if (e.target.dataset.action === 'delete-symptom') {
        const symptomId = e.target.dataset.symptomId;
        showDeleteSymptomConfirmation(symptomId);
    }

    if (e.target.dataset.action === 'edit-symptom') {
        const symptomId = e.target.dataset.symptomId;

        // Fetch symptom data
        fetch('/api/symptoms/' + symptomId)
            .then(response => response.json())
            .then(symptom => {
                const modal = document.getElementById('edit-symptom-modal');
                const form = document.getElementById('edit-symptom-form');

                // Get Alpine.js instance
                const alpineData = Alpine.$data(form);

                // Set form values
                alpineData.symptomId = symptomId;
                alpineData.painLevel = symptom.pain_level || 5;
                alpineData.painLocation = symptom.pain_location || '';
                alpineData.painType = symptom.pain_type || '';
                alpineData.notes = symptom.notes || '';

                // Parse symptoms array
                if (symptom.symptoms) {
                    try {
                        const parsed = JSON.parse(symptom.symptoms);
                        alpineData.symptoms = Array.isArray(parsed) ? parsed : [];
                    } catch(e) {
                        alpineData.symptoms = [];
                    }
                } else {
                    alpineData.symptoms = [];
                }

                // Show modal
                modal.showModal();
            })
            .catch(error => {
                console.error('Error loading symptom:', error);
            });
    }
});

let currentDeleteSymptomId = null;

function showDeleteSymptomConfirmation(symptomId) {
    currentDeleteSymptomId = symptomId;
    document.getElementById('delete-symptom-confirm').showModal();
}

function confirmDeleteSymptom() {
    if (!currentDeleteSymptomId) return;

    const csrfToken = document.querySelector('meta[name=csrf-token]').content;
    fetch('/api/symptoms/' + currentDeleteSymptomId, {
        method: 'DELETE',
        headers: {'X-CSRF-Token': csrfToken}
    })
    .then(response => {
        if (response.ok) {
            htmx.trigger('#recent-symptoms', 'refresh');
            const notif = document.getElementById('notification');
            notif.innerHTML = '<div class=\'alert-success\'>Symptom deleted successfully!</div>';
            notif.style.display = 'block';
            setTimeout(() => notif.style.display = 'none', 3000);
        } else {
            response.text().then(text => console.error('Error:', text));
            htmx.trigger('#recent-symptoms', 'refresh');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        htmx.trigger('#recent-symptoms', 'refresh');
    });

    document.getElementById('delete-symptom-confirm').close();
}
</script>

<!-- Delete Symptom Confirmation Dialog -->
<dialog id="delete-symptom-confirm">
    <article style="max-width: 400px;">
        <header>
            <h3>Confirm Deletion</h3>
            <button aria-label="Close" rel="prev" onclick="document.getElementById('delete-symptom-confirm').close()"></button>
        </header>
        <p>Delete this symptom log?</p>
        <p><small class="text-danger">This action cannot be undone.</small></p>
        <footer>
            <div class="grid-2">
                <button type="button" class="secondary" onclick="document.getElementById('delete-symptom-confirm').close()">Cancel</button>
                <button type="button" class="contrast" onclick="confirmDeleteSymptom()" style="background-color: var(--danger-primary); border-color: var(--danger-primary);">Delete</button>
            </div>
        </footer>
    </article>
</dialog>

{{ else }}
<article class="card" style="text-align: center; padding: var(--space-8);">
    <hgroup>
        <h3>No Active Course</h3>
        <p>Create a course to track symptoms</p>
    </hgroup>
    <a href="/courses" role="button" class="btn btn-lg">Manage Courses</a>
</article>
{{ end }}
{{ end }}
