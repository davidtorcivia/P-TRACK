{{ define "content" }}
<hgroup>
    <h2>Symptom Tracking</h2>
    <p>Log and monitor your symptoms</p>
</hgroup>

<div id="notification" style="display: none; margin-bottom: 1rem;" role="alert"></div>

{{ if .ActiveCourse }}
<article>
    <header><h3>Log Symptoms</h3></header>

    <form x-data="{
        painLevel: 5,
        painLocation: '',
        painType: '',
        symptoms: [],
        notes: ''
    }" @submit.prevent="
        const btn = $el.querySelector('button[type=submit]');
        btn.disabled = true;
        btn.setAttribute('aria-busy', 'true');

        fetch('/api/symptoms', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content
            },
            body: JSON.stringify({
                course_id: {{ .ActiveCourse.ID }},
                pain_level: parseInt(painLevel),
                pain_location: painLocation,
                pain_type: painType,
                symptoms: symptoms,
                notes: notes
            })
        })
        .then(response => {
            btn.disabled = false;
            btn.removeAttribute('aria-busy');
            if (response.ok) {
                painLevel = 5;
                painLocation = '';
                painType = '';
                symptoms = [];
                notes = '';

                const notif = document.getElementById('notification');
                notif.innerHTML = '<article><mark>Symptoms logged successfully!</mark></article>';
                notif.style.display = 'block';
                setTimeout(() => notif.style.display = 'none', 3000);

                htmx.trigger('#recent-symptoms', 'refresh');
            } else {
                response.text().then(text => {
                    const notif = document.getElementById('notification');
                    notif.innerHTML = '<article><del>Error: ' + text + '</del></article>';
                    notif.style.display = 'block';
                });
            }
        })
        .catch(error => {
            btn.disabled = false;
            btn.removeAttribute('aria-busy');
            const notif = document.getElementById('notification');
            notif.innerHTML = '<article><del>Error: ' + error.message + '</del></article>';
            notif.style.display = 'block';
        });
    ">
        <div class="grid-3">
            <div>
                <label>
                    Pain Level: <span x-text="painLevel"></span>/10
                    <input type="range" x-model="painLevel" min="1" max="10">
                </label>
            </div>

            <div>
                <label>
                    Location
                    <select x-model="painLocation">
                        <option value="">Select</option>
                        <option value="injection_site">Injection Site</option>
                        <option value="abdomen">Abdomen</option>
                        <option value="back">Back</option>
                        <option value="other">Other</option>
                    </select>
                </label>
            </div>

            <div>
                <label>
                    Type
                    <select x-model="painType">
                        <option value="">Select</option>
                        <option value="sharp">Sharp</option>
                        <option value="dull">Dull</option>
                        <option value="aching">Aching</option>
                        <option value="cramping">Cramping</option>
                        <option value="other">Other</option>
                    </select>
                </label>
            </div>
        </div>

        <fieldset>
            <legend>Additional Symptoms</legend>
            <div class="grid-4">
                <label><input type="checkbox" x-model="symptoms" value="nausea"> Nausea</label>
                <label><input type="checkbox" x-model="symptoms" value="fatigue"> Fatigue</label>
                <label><input type="checkbox" x-model="symptoms" value="headache"> Headache</label>
                <label><input type="checkbox" x-model="symptoms" value="mood_changes"> Mood Changes</label>
                <label><input type="checkbox" x-model="symptoms" value="bloating"> Bloating</label>
                <label><input type="checkbox" x-model="symptoms" value="breast_tenderness"> Tenderness</label>
                <label><input type="checkbox" x-model="symptoms" value="spotting"> Spotting</label>
                <label><input type="checkbox" x-model="symptoms" value="hot_flashes"> Hot Flashes</label>
            </div>
        </fieldset>

        <label>
            Notes
            <textarea x-model="notes" rows="3"></textarea>
        </label>

        <button type="submit">Log Symptoms</button>
    </form>
</article>

<article>
    <header><h3>Recent Symptoms</h3></header>
    <div id="recent-symptoms" hx-get="/api/symptoms/recent" hx-trigger="load, refresh from:body">
        <p aria-busy="true">Loading...</p>
    </div>
    <footer>
        <a href="/symptoms/history" role="button" class="outline">View History</a>
    </footer>
</article>

<script>
document.addEventListener('click', function(e) {
    if (e.target.dataset.action === 'delete-symptom') {
        const symptomId = e.target.dataset.symptomId;
        if (confirm('Delete this symptom log?')) {
            const csrfToken = document.querySelector('meta[name=csrf-token]').content;
            fetch('/api/symptoms/' + symptomId, {
                method: 'DELETE',
                headers: {'X-CSRF-Token': csrfToken}
            })
            .then(response => {
                if (response.ok) {
                    htmx.trigger('#recent-symptoms', 'refresh');
                    const notif = document.getElementById('notification');
                    notif.innerHTML = '<article><mark>Symptom deleted successfully!</mark></article>';
                    notif.style.display = 'block';
                    setTimeout(() => notif.style.display = 'none', 3000);
                } else {
                    response.text().then(text => alert('Error: ' + text));
                }
            })
            .catch(error => alert('Error: ' + error.message));
        }
    }

    if (e.target.dataset.action === 'edit-symptom') {
        const symptomId = e.target.dataset.symptomId;
        window.location.href = '/symptoms/' + symptomId + '/edit';
    }
});
</script>

{{ else }}
<article style="text-align: center;">
    <hgroup>
        <h3>No Active Course</h3>
        <p>Create a course to track symptoms</p>
    </hgroup>
    <a href="/courses" role="button">Manage Courses</a>
</article>
{{ end }}
{{ end }}
