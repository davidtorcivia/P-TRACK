{{ define "content" }}
<hgroup>
    <h2>Treatment Courses</h2>
    <p>Manage your treatment cycles</p>
</hgroup>

<a href="javascript:document.getElementById('new-course').showModal()" role="button" class="btn w-full" style="margin-bottom: var(--space-6);">Create Course</a>

<!-- Active Course -->
{{ if .ActiveCourse }}
<article class="card">
    <header>
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <hgroup>
                <h3>{{ .ActiveCourse.Name }}</h3>
                <span class="badge badge-success">Active Course</span>
            </hgroup>
        </div>
    </header>
    <div class="grid-2" style="margin-bottom: var(--space-4);">
        <div>
            <p class="text-secondary text-sm mb-1">Started</p>
            <p><strong>{{ .ActiveCourse.StartDate }}</strong></p>
        </div>
        {{ if .ActiveCourse.ExpectedEndDate }}
        <div>
            <p class="text-secondary text-sm mb-1">Expected End</p>
            <p><strong>{{ .ActiveCourse.ExpectedEndDate }}</strong></p>
        </div>
        {{ end }}
    </div>
    {{ if .ActiveCourse.Notes }}
    <div style="margin-bottom: var(--space-4);">
        <p class="text-secondary text-sm mb-1">Notes</p>
        <p>{{ .ActiveCourse.Notes }}</p>
    </div>
    {{ end }}
    <footer>
        <div class="grid-2">
            <button onclick="document.getElementById('edit-course-{{ .ActiveCourse.ID }}').showModal()" class="btn outline secondary w-full">
                Edit
            </button>
            <button onclick="if(confirm('Close this course?')) {
                fetch('/api/courses/{{ .ActiveCourse.ID }}/close', {
                    method: 'POST',
                    headers: {'X-CSRF-Token': '{{ $.CSRFToken }}'}
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        response.text().then(text => console.error('Error:', text));
                        window.location.reload();
                    }
                });
            }" class="btn outline w-full">Close Course</button>
        </div>
    </footer>
</article>

<!-- Edit Active Course Modal -->
<dialog id="edit-course-{{ .ActiveCourse.ID }}">
    <article class="modal-card">
        <header>
            <h3>Edit Course</h3>
            <button aria-label="Close" rel="prev" onclick="document.getElementById('edit-course-{{ .ActiveCourse.ID }}').close()"></button>
        </header>
        <form onsubmit="event.preventDefault();
            const formData = new FormData(event.target);
            const data = {
                name: formData.get('name'),
                start_date: formData.get('start_date'),
                expected_end_date: formData.get('expected_end_date') || null,
                notes: formData.get('notes') || null
            };
            const btn = event.target.querySelector('button[type=submit]');
            btn.disabled = true;
            btn.setAttribute('aria-busy', 'true');

            fetch('/api/courses/{{ .ActiveCourse.ID }}', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': '{{ $.CSRFToken }}'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    return response.text().then(text => {
                        alert('Error: ' + text);
                        btn.disabled = false;
                        btn.removeAttribute('aria-busy');
                    });
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.removeAttribute('aria-busy');
            });
        ">
            <label>
                Course Name
                <input type="text" name="name" value="{{ .ActiveCourse.Name }}" required>
            </label>
            <div class="grid-2">
                <label>
                    Start Date
                    <input type="date" name="start_date" value="{{ .ActiveCourse.StartDateISO }}" required>
                </label>
                <label>
                    Expected End Date
                    <input type="date" name="expected_end_date" value="{{ .ActiveCourse.ExpectedEndDateISO }}">
                </label>
            </div>
            <label>
                Notes
                <textarea name="notes" rows="2">{{ .ActiveCourse.Notes }}</textarea>
            </label>
            <footer>
                <div class="grid-2">
                    <button type="button" class="secondary" onclick="document.getElementById('edit-course-{{ .ActiveCourse.ID }}').close()">Cancel</button>
                    <button type="submit">Save Changes</button>
                </div>
            </footer>
        </form>
    </article>
</dialog>
{{ end }}

<!-- Past Courses -->
{{ if .PastCourses }}
<h3 style="margin-top: var(--space-8); margin-bottom: var(--space-4);">Past Courses</h3>
{{ range .PastCourses }}
<article class="card">
    <hgroup>
        <h4>{{ .Name }}</h4>
        <p class="text-secondary">{{ .StartDate }}{{ if .ActualEndDate }} - {{ .ActualEndDate }}{{ end }}</p>
    </hgroup>
    {{ if .Notes }}
    <p class="text-muted text-sm" style="margin-top: var(--space-2);">{{ .Notes }}</p>
    {{ end }}
    <footer>
        <div class="grid-3">
            <button onclick="document.getElementById('edit-course-{{ .ID }}').showModal()" class="btn-sm outline secondary w-full">
                Edit
            </button>
            <button onclick="
                fetch('/api/courses/{{ .ID }}/activate', {
                    method: 'POST',
                    headers: {'X-CSRF-Token': '{{ $.CSRFToken }}'}
                }).then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        console.error('Error activating course');
                        window.location.reload();
                    }
                });
            " class="btn-sm outline w-full">Reactivate</button>
            <button onclick="if(confirm('Delete {{ .Name }}? This will delete all associated data.')) {
                fetch('/api/courses/{{ .ID }}', {
                    method: 'DELETE',
                    headers: {'X-CSRF-Token': '{{ $.CSRFToken }}'}
                }).then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        console.error('Error deleting course');
                        window.location.reload();
                    }
                });
            }" class="btn-sm outline secondary w-full" style="color: var(--danger-primary); border-color: var(--danger-primary);">Delete</button>
        </div>
    </footer>
</article>

<!-- Edit Past Course Modal -->
<dialog id="edit-course-{{ .ID }}">
    <article class="modal-card">
        <header>
            <h3>Edit Course</h3>
            <button aria-label="Close" rel="prev" onclick="document.getElementById('edit-course-{{ .ID }}').close()"></button>
        </header>
        <form onsubmit="event.preventDefault();
            const formData = new FormData(event.target);
            const data = {
                name: formData.get('name'),
                start_date: formData.get('start_date'),
                expected_end_date: formData.get('expected_end_date') || null,
                actual_end_date: formData.get('actual_end_date') || null,
                notes: formData.get('notes') || null
            };
            const btn = event.target.querySelector('button[type=submit]');
            btn.disabled = true;
            btn.setAttribute('aria-busy', 'true');

            fetch('/api/courses/{{ .ID }}', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': '{{ $.CSRFToken }}'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    return response.text().then(text => {
                        alert('Error: ' + text);
                        btn.disabled = false;
                        btn.removeAttribute('aria-busy');
                    });
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.removeAttribute('aria-busy');
            });
        ">
            <label>
                Course Name
                <input type="text" name="name" value="{{ .Name }}" required>
            </label>
            <div class="grid-2">
                <label>
                    Start Date
                    <input type="date" name="start_date" value="{{ .StartDateISO }}" required>
                </label>
                <label>
                    Actual End Date
                    <input type="date" name="actual_end_date" value="{{ .ActualEndDateISO }}">
                </label>
            </div>
            <label>
                Expected End Date
                <input type="date" name="expected_end_date" value="{{ .ExpectedEndDateISO }}">
            </label>
            <label>
                Notes
                <textarea name="notes" rows="2">{{ .Notes }}</textarea>
            </label>
            <footer>
                <div class="grid-2">
                    <button type="button" class="secondary" onclick="document.getElementById('edit-course-{{ .ID }}').close()">Cancel</button>
                    <button type="submit">Save Changes</button>
                </div>
            </footer>
        </form>
    </article>
</dialog>
{{ end }}
{{ end }}

<!-- No Courses -->
{{ if not .ActiveCourse }}
{{ if not .PastCourses }}
<article class="card" style="text-align: center; padding: var(--space-8);">
    <hgroup>
        <h3>No Courses Yet</h3>
        <p>Create your first treatment course to start tracking</p>
    </hgroup>
    <a href="javascript:document.getElementById('new-course').showModal()" role="button" class="btn btn-lg">Create Your First Course</a>
</article>
{{ end }}
{{ end }}

<!-- New Course Modal -->
<dialog id="new-course">
    <article class="modal-card">
        <header>
            <h3>Create New Course</h3>
            <button aria-label="Close" rel="prev" onclick="document.getElementById('new-course').close()"></button>
        </header>
        <form onsubmit="event.preventDefault();
            const formData = new FormData(event.target);
            const data = {
                name: formData.get('name'),
                start_date: formData.get('start_date'),
                expected_end_date: formData.get('expected_end_date') || null,
                notes: formData.get('notes') || null
            };
            const btn = event.target.querySelector('button[type=submit]');
            btn.disabled = true;
            btn.setAttribute('aria-busy', 'true');

            fetch('/api/courses', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': '{{ .CSRFToken }}'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    return response.text().then(text => {
                        alert('Error: ' + text);
                        btn.disabled = false;
                        btn.removeAttribute('aria-busy');
                    });
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.removeAttribute('aria-busy');
            });
        ">
            <label>
                Course Name
                <input type="text" name="name" placeholder="e.g., IVF Cycle 1" required>
            </label>
            <div class="grid-2">
                <label>
                    Start Date
                    <input type="date" name="start_date" required>
                </label>
                <label>
                    Expected End Date
                    <input type="date" name="expected_end_date">
                </label>
            </div>
            <label>
                Notes
                <textarea name="notes" rows="2"></textarea>
            </label>
            <footer>
                <div class="grid-2">
                    <button type="button" class="secondary" onclick="document.getElementById('new-course').close()">Cancel</button>
                    <button type="submit">Create Course</button>
                </div>
            </footer>
        </form>
    </article>
</dialog>
{{ end }}
