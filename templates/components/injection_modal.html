{{ define "injection_modal" }}
<div class="modal-overlay"
     @click.self="showInjectionModal = false"
     style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 1rem;">

    <article class="modal-card" x-data="{
        selectedSide: '',
        showDetails: false,
        painLevel: 5,
        hasKnots: false,
        siteReaction: 'none',
        notes: '',
        submitting: false
    }" style="max-width: 600px; width: 100%; margin: 0;">

        <header>
            <button @click="showInjectionModal = false"
                    aria-label="Close"
                    class="close"
                    style="float: right; background: none; border: none; font-size: 1.5rem; cursor: pointer;">
                ✕
            </button>
            <h2>Log Injection</h2>
        </header>

        <!-- Quick Side Selection -->
        <div style="margin-bottom: 1.5rem;">
            <p><strong>Which side?</strong></p>
            <div class="grid">
                <button type="button"
                        @click="selectedSide = 'left'"
                        :class="selectedSide === 'left' ? '' : 'outline'"
                        style="font-size: 1.2rem; padding: 2rem;">
                    ⬅️ LEFT
                </button>
                <button type="button"
                        @click="selectedSide = 'right'"
                        :class="selectedSide === 'right' ? '' : 'outline'"
                        style="font-size: 1.2rem; padding: 2rem;">
                    RIGHT ➡️
                </button>
            </div>
        </div>

        <!-- More Details Accordion -->
        <details x-model="showDetails">
            <summary>▼ More Details (optional)</summary>

            <div style="padding: 1rem 0;">
                <!-- Pain Level -->
                <label for="pain-level">
                    <strong>Pain Level:</strong> <span x-text="painLevel"></span>/10
                    <input type="range"
                           id="pain-level"
                           min="1"
                           max="10"
                           x-model="painLevel"
                           style="margin-top: 0.5rem;">
                </label>

                <!-- Knots/Hardness -->
                <label for="has-knots">
                    <input type="checkbox" id="has-knots" x-model="hasKnots" role="switch">
                    Knots or hardness present
                </label>

                <!-- Site Reaction -->
                <label for="site-reaction">
                    Site Reaction
                    <select id="site-reaction" x-model="siteReaction">
                        <option value="none">None</option>
                        <option value="redness">Redness</option>
                        <option value="swelling">Swelling</option>
                        <option value="bruising">Bruising</option>
                        <option value="other">Other</option>
                    </select>
                </label>

                <!-- Notes -->
                <label for="notes">
                    Notes
                    <textarea id="notes"
                              x-model="notes"
                              rows="3"
                              placeholder="Any additional observations..."></textarea>
                </label>

                <!-- Administered By -->
                <label for="administered-by">
                    Administered By
                    <select id="administered-by" name="administered_by">
                        <option value="{{ .UserID }}" selected>You</option>
                    </select>
                </label>
            </div>
        </details>

        <!-- Form Submission -->
        <footer>
            <div class="grid">
                <button type="button"
                        @click="showInjectionModal = false"
                        class="secondary">
                    Cancel
                </button>
                <button type="button"
                        @click="
                            if (selectedSide === '') return;
                            submitting = true;
                            const btn = $el;
                            btn.disabled = true;
                            btn.textContent = 'Getting token...';

                            // First, get a fresh CSRF token
                            fetch('/api/csrf-token')
                                .then(response => response.json())
                                .then(data => {
                                    btn.textContent = 'Saving...';
                                    const adminBy = document.getElementById('administered-by')?.value || {{ .UserID }};

                                    fetch('/api/injections', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-CSRF-Token': data.csrf_token
                                        },
                                        body: JSON.stringify({
                                            course_id: {{ .ActiveCourse.ID }},
                                            side: selectedSide,
                                            pain_level: showDetails ? parseInt(painLevel) : null,
                                            has_knots: hasKnots,
                                            site_reaction: siteReaction !== 'none' ? siteReaction : null,
                                            notes: notes || null,
                                            administered_by: parseInt(adminBy)
                                        })
                                    })
                                    .then(response => {
                                        if (response.ok) {
                                            showInjectionModal = false;
                                            window.location.reload();
                                        } else {
                                            return response.text().then(text => {
                                                alert('Error: ' + text);
                                                btn.disabled = false;
                                                btn.textContent = 'Save Injection';
                                                submitting = false;
                                            });
                                        }
                                    })
                                    .catch(error => {
                                        alert('Error: ' + error.message);
                                        btn.disabled = false;
                                        btn.textContent = 'Save Injection';
                                        submitting = false;
                                    });
                                })
                                .catch(error => {
                                    alert('Error getting token: ' + error.message);
                                    btn.disabled = false;
                                    btn.textContent = 'Save Injection';
                                    submitting = false;
                                });
                        "
                        :disabled="selectedSide === '' || submitting">
                    Save Injection
                </button>
            </div>
        </footer>
    </article>
</div>

<style>
    .modal-overlay {
        animation: fadeIn 0.2s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .modal-overlay {
            align-items: flex-start;
            padding: 0.5rem;
        }
    }
</style>
{{ end }}